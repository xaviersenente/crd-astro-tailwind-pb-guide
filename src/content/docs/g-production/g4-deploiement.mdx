---
title: Déploiement
description: Déployer le front et PocketBase en production
---

## Déploiement du front (Astro)

### Option 1 : Vercel (recommandé)

1. **Push sur GitHub**

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/username/conservatoire.git
git push -u origin main
```

2. **Connecter à Vercel**

- Aller sur [vercel.com](https://vercel.com)
- Import GitHub repository
- Configuration automatique détectée

3. **Variables d'environnement**

Dans Vercel Dashboard > Settings > Environment Variables :

```
PUBLIC_POCKETBASE_URL=https://pb.conservatoire-exemple.fr
```

4. **Déployer**

```bash
# Ou via CLI
npm i -g vercel
vercel --prod
```

### Option 2 : Netlify

1. **Configuration netlify.toml**

```toml
[build]
  command = "npm run build"
  publish = "dist"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[build.environment]
  NODE_VERSION = "18"
```

2. **Déployer**

```bash
# Via CLI
npm install -g netlify-cli
netlify deploy --prod
```

### Option 3 : Hébergement classique (cPanel, etc.)

```bash
# Build du projet
npm run build

# Uploader le dossier `dist/` via FTP
```

## Déploiement de PocketBase

### Option 1 : VPS (DigitalOcean, Hetzner, OVH)

#### 1. Connexion SSH

```bash
ssh root@votre-serveur.com
```

#### 2. Installation

```bash
# Créer un utilisateur
adduser pocketbase
usermod -aG sudo pocketbase
su - pocketbase

# Télécharger PocketBase
wget https://github.com/pocketbase/pocketbase/releases/download/v0.xx.x/pocketbase_0.xx.x_linux_amd64.zip
unzip pocketbase_*.zip
chmod +x pocketbase
```

#### 3. Configuration systemd

Créer `/etc/systemd/system/pocketbase.service` :

```ini
[Unit]
Description=PocketBase
After=network.target

[Service]
Type=simple
User=pocketbase
Group=pocketbase
WorkingDirectory=/home/pocketbase
ExecStart=/home/pocketbase/pocketbase serve --http="0.0.0.0:8090"
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Démarrer le service :

```bash
sudo systemctl daemon-reload
sudo systemctl enable pocketbase
sudo systemctl start pocketbase
sudo systemctl status pocketbase
```

#### 4. Configuration Nginx

Créer `/etc/nginx/sites-available/pocketbase` :

```nginx
server {
    listen 80;
    server_name pb.conservatoire-exemple.fr;

    location / {
        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Upload size
        client_max_body_size 10M;
    }
}
```

Activer le site :

```bash
sudo ln -s /etc/nginx/sites-available/pocketbase /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 5. SSL avec Let's Encrypt

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d pb.conservatoire-exemple.fr
```

### Option 2 : Fly.io

1. **Créer fly.toml**

```toml
app = "conservatoire-pb"

[build]
  image = "ghcr.io/muchobien/pocketbase:latest"

[env]
  PB_PORT = "8080"

[[services]]
  internal_port = 8080
  protocol = "tcp"

  [[services.ports]]
    handlers = ["http"]
    port = 80

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

[mounts]
  source = "pb_data"
  destination = "/pb_data"
```

2. **Déployer**

```bash
fly launch
fly volumes create pb_data --size 1
fly deploy
```

### Option 3 : Docker

1. **Créer Dockerfile**

```dockerfile
FROM alpine:latest

ARG PB_VERSION=0.xx.x

RUN apk add --no-cache \
    unzip \
    ca-certificates

ADD https://github.com/pocketbase/pocketbase/releases/download/v${PB_VERSION}/pocketbase_${PB_VERSION}_linux_amd64.zip /tmp/pb.zip
RUN unzip /tmp/pb.zip -d /pb/

EXPOSE 8080

CMD ["/pb/pocketbase", "serve", "--http=0.0.0.0:8080"]
```

2. **docker-compose.yml**

```yaml
version: "3.8"

services:
  pocketbase:
    build: .
    ports:
      - "8090:8080"
    volumes:
      - ./pb_data:/pb/pb_data
    restart: unless-stopped
```

3. **Déployer**

```bash
docker-compose up -d
```

## Stockage des fichiers

### Option 1 : Stockage local

Configuré par défaut dans `pb_data/storage/`

### Option 2 : S3-compatible (AWS, Backblaze, etc.)

Configuration dans l'admin PocketBase :

1. Settings > Files storage
2. Choisir S3
3. Configurer :
   - Bucket name
   - Region
   - Endpoint
   - Access key
   - Secret key

### Option 3 : Cloudinary

Utiliser un hook pour uploader sur Cloudinary après création :

```js
// pb_hooks/files.pb.js
onRecordAfterCreateRequest((e) => {
  // Upload vers Cloudinary
  const file = e.record.get("image");
  // ... logique d'upload
});
```

## Variables d'environnement

### Production

`.env.production` :

```env
PUBLIC_POCKETBASE_URL=https://pb.conservatoire-exemple.fr
PUBLIC_SITE_URL=https://www.conservatoire-exemple.fr
PUBLIC_GA_ID=G-XXXXXXXXXX
```

### Configuration Astro

```js
// astro.config.mjs
export default defineConfig({
  site: process.env.PUBLIC_SITE_URL || "http://localhost:4321",
  // ...
});
```

## Backups

### Script de backup automatique

Créer `/home/pocketbase/backup.sh` :

```bash
#!/bin/bash

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/home/pocketbase/backups"
PB_DATA="/home/pocketbase/pb_data"

mkdir -p $BACKUP_DIR

# Backup de la DB
cp $PB_DATA/data.db "$BACKUP_DIR/data_$DATE.db"

# Backup des fichiers
tar -czf "$BACKUP_DIR/storage_$DATE.tar.gz" $PB_DATA/storage/

# Garder seulement les 7 derniers backups
find $BACKUP_DIR -name "data_*.db" -mtime +7 -delete
find $BACKUP_DIR -name "storage_*.tar.gz" -mtime +7 -delete

echo "Backup créé : $DATE"
```

### Cron job

```bash
crontab -e

# Backup quotidien à 3h du matin
0 3 * * * /home/pocketbase/backup.sh >> /home/pocketbase/backup.log 2>&1
```

### Backup vers S3

```bash
#!/bin/bash
# backup-s3.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="backup_$DATE.tar.gz"

# Créer l'archive
tar -czf /tmp/$BACKUP_FILE /home/pocketbase/pb_data

# Upload vers S3
aws s3 cp /tmp/$BACKUP_FILE s3://conservatoire-backups/

# Nettoyer
rm /tmp/$BACKUP_FILE
```

## Monitoring

### Uptime monitoring

- [UptimeRobot](https://uptimerobot.com/)
- [Pingdom](https://www.pingdom.com/)
- [StatusCake](https://www.statuscake.com/)

### Logs

```bash
# Logs PocketBase
journalctl -u pocketbase -f

# Logs Nginx
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### Alertes

Configurer des alertes email en cas de :

- Downtime
- Erreurs 500
- Espace disque faible
- CPU/RAM élevés

## Sécurité

### Firewall

```bash
# UFW (Ubuntu)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### Fail2ban

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### Mises à jour

```bash
# Mises à jour système
sudo apt update && sudo apt upgrade -y

# Mettre à jour PocketBase
cd /home/pocketbase
wget https://github.com/pocketbase/pocketbase/releases/download/v0.xx.x/pocketbase_0.xx.x_linux_amd64.zip
unzip pocketbase_*.zip
chmod +x pocketbase
sudo systemctl restart pocketbase
```

## Checklist déploiement

- ✅ Front déployé sur Vercel/Netlify
- ✅ PocketBase déployé sur VPS/Fly.io
- ✅ SSL/HTTPS configuré
- ✅ DNS configurés
- ✅ Variables d'environnement définies
- ✅ CORS configuré correctement
- ✅ Backups automatiques en place
- ✅ Monitoring configuré
- ✅ Logs accessibles
- ✅ Sécurité (firewall, fail2ban)
- ✅ Documentation à jour
- ✅ Tests en production effectués
